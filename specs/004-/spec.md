# Feature Specification: 地区化购物车功能完善

**Feature Branch**: `004-`
**Created**: 2025-10-13
**Status**: Draft
**Input**: 用户描述: "开始处理一下购物车吧 不同地区加购的产品，购物车也有地区的概念，结合整个项目做一下规划"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看当前地区购物车 (Priority: P1)

用户在选择地区后,进入购物车页面能够看到该地区的所有商品,包括商品图片、名称、单价、数量、小计金额,以及购物车总计信息(商品种类、数量、总金额),实现基本的购物车查看功能。

**Why this priority**: 这是购物车的核心功能,没有商品列表展示,用户无法查看已添加的商品,购物车将失去意义。这是最小可行产品(MVP)的基础功能,必须优先实现。

**Independent Test**: 可以通过在特定地区(如"江苏省-南京市")添加3种不同商品,切换到该地区,访问购物车页面,验证是否正确显示商品列表和统计信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在"江苏省-南京市"添加了3种商品(大米2斤、面粉1kg、小麦5斤), **When** 用户切换到"江苏省-南京市"并进入购物车, **Then** 购物车显示3个商品卡片,每个卡片包含商品图片、名称、单价、数量控制器、小计金额
2. **Given** 用户在购物车查看商品, **When** 页面加载完成, **Then** 底部显示统计信息:商品种类3种、商品数量8件、合计金额¥XXX.XX
3. **Given** 用户在"江苏省-南京市"购物车有商品, **When** 用户切换到"浙江省-杭州市", **Then** 购物车显示空状态,提示"当前地区:浙江省-杭州市,购物车是空的"
4. **Given** 用户首次进入购物车且未添加任何商品, **When** 用户查看购物车, **Then** 显示空状态插画和提示文字"购物车是空的,去添加一些商品吧~",以及当前地区信息

---

### User Story 2 - 修改商品数量与删除 (Priority: P1)

用户需要在购物车中灵活调整商品数量(增加或减少),或直接删除不需要的商品,实时更新小计和总计金额,提供流畅的购物车编辑体验。

**Why this priority**: 用户在购物过程中经常需要调整数量或移除商品,这是购物车的基本编辑功能。没有这个功能,用户无法灵活管理购物车,会严重影响用户体验。

**Independent Test**: 可以通过在购物车添加商品,验证点击"+"按钮增加数量、"-"按钮减少数量、删除按钮移除商品,以及金额实时更新是否正确来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户购物车有商品"大米,数量2斤,单价¥5/斤", **When** 用户点击"+"按钮, **Then** 数量变为3斤,小计变为¥15,总计同步更新
2. **Given** 用户购物车有商品"大米,数量3斤", **When** 用户点击"-"按钮, **Then** 数量变为2斤,小计和总计同步更新
3. **Given** 用户购物车有商品"大米,数量1斤", **When** 用户点击"-"按钮, **Then** 数量保持1斤不变(最小数量为1)
4. **Given** 用户购物车有商品"大米", **When** 用户点击删除按钮(垃圾桶图标), **Then** 商品从购物车移除,商品种类减1,总计更新
5. **Given** 用户购物车有5种商品, **When** 用户逐一删除所有商品, **Then** 购物车变为空状态,显示空状态提示

---

### User Story 3 - 地区切换时的购物车隔离 (Priority: P1)

用户在不同地区添加商品后,切换地区时能够看到对应地区的购物车内容,实现地区级别的购物车隔离,确保不同地区的商品互不干扰。

**Why this priority**: 这是本项目的核心特性,不同地区的商品供应商、价格、库存可能不同,必须按地区隔离购物车,避免跨地区下单导致的订单履约问题。这是系统设计的基础逻辑。

**Independent Test**: 可以通过在"江苏省-南京市"添加大米,切换到"浙江省-杭州市"添加面粉,再分别切换回两个地区,验证购物车内容是否正确隔离来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在"江苏省-南京市"添加了大米2斤, **When** 用户切换到"浙江省-杭州市", **Then** 购物车显示空状态(因为杭州购物车为空)
2. **Given** 用户在"浙江省-杭州市"添加了面粉1kg, **When** 用户切换回"江苏省-南京市", **Then** 购物车显示大米2斤(南京购物车内容)
3. **Given** 用户在"江苏省-南京市"购物车有3种商品,"浙江省-杭州市"购物车有2种商品, **When** 用户在TabBar购物车图标上查看徽标, **Then** 徽标显示总数量5(两个地区购物车商品种类总和)
4. **Given** 用户在"江苏省-南京市"购物车, **When** 用户通过RegionBar切换到"浙江省-杭州市", **Then** 购物车页面实时刷新,显示杭州地区的购物车内容

---

### User Story 4 - 清空购物车功能 (Priority: P2)

用户需要快速清空当前地区的所有购物车商品,避免逐个删除的繁琐操作,同时提供确认机制防止误操作。

**Why this priority**: 这是便捷的批量操作功能,虽然不是核心必需,但能显著提升用户体验。优先级低于基本的查看和编辑功能,可以在核心功能完成后添加。

**Independent Test**: 可以通过在购物车添加5种商品,点击"清空购物车"按钮,验证是否弹出确认对话框,确认后是否清空购物车来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户购物车有5种商品, **When** 用户点击"清空购物车"按钮, **Then** 显示确认对话框,内容为"确定清空当前地区的购物车吗?此操作不可恢复"
2. **Given** 用户看到清空购物车确认对话框, **When** 用户点击"取消", **Then** 对话框关闭,购物车商品保持不变
3. **Given** 用户看到清空购物车确认对话框, **When** 用户点击"确定", **Then** 当前地区购物车所有商品被清空,显示空状态,显示Toast提示"购物车已清空"
4. **Given** 用户购物车为空, **When** 用户点击"清空购物车"按钮, **Then** 按钮显示禁用状态,无法点击

---

### User Story 5 - 去结算与订单生成 (Priority: P1)

用户在购物车确认商品和数量后,点击"去结算"按钮,跳转到订单确认页面,填写配送信息或选择核销门店,完成支付后生成订单和核销券。

**Why this priority**: 这是购物车的最终目标,将购物车商品转化为订单。没有结算功能,购物车只是展示工具,无法完成购买流程。这是核心业务闭环的关键环节。

**Independent Test**: 可以通过在购物车添加商品,点击"去结算"按钮,验证是否正确跳转到订单确认页面,并携带商品列表和地区信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户购物车有3种商品且已登录, **When** 用户点击"去结算"按钮, **Then** 跳转到订单确认页面,显示商品列表、地区信息、总金额,以及配送方式选择(核销自提/跑腿配送)
2. **Given** 用户购物车有商品但未登录, **When** 用户点击"去结算"按钮, **Then** 跳转到登录页面,登录成功后自动返回订单确认页面
3. **Given** 用户购物车为空, **When** 用户点击"去结算"按钮, **Then** 按钮显示禁用状态,无法点击
4. **Given** 用户在订单确认页面完成支付, **When** 支付成功, **Then** 生成订单,生成对应数量的核销券,清空当前地区购物车,跳转到订单详情页显示订单信息和核销券入口

---

### User Story 6 - 多地区购物车概览 (Priority: P3)

用户能够查看所有地区的购物车商品总数(用于TabBar徽标显示),以及在购物车页面顶部显示当前地区信息,方便用户了解购物车全局状态。

**Why this priority**: 这是辅助性的信息展示功能,帮助用户了解跨地区购物车状态,但不影响核心购物流程。优先级较低,可以在基本功能完成后添加。

**Independent Test**: 可以通过在3个不同地区分别添加商品,验证TabBar购物车徽标是否显示总数量,以及购物车页面是否显示当前地区信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在"江苏省-南京市"购物车有2种商品,"浙江省-杭州市"购物车有3种商品, **When** 用户在任意页面查看TabBar, **Then** 购物车图标右上角显示徽标"5"(总商品种类数)
2. **Given** 用户所有地区购物车都为空, **When** 用户查看TabBar购物车图标, **Then** 不显示徽标
3. **Given** 用户在"江苏省-南京市"购物车, **When** 页面加载完成, **Then** 顶部RegionBar显示"江苏省-南京市",购物车内容与该地区对应
4. **Given** 用户在购物车页面, **When** 用户点击RegionBar切换地区, **Then** 购物车内容立即切换到新地区的购物车,统计信息同步更新

---

### User Story 7 - 购物车前端缓存持久化 (Priority: P2)

用户在购物车添加商品后,购物车数据通过前端本地缓存(localStorage)持久化保存,即使关闭小程序再次打开,购物车商品仍然保留。**重要**: 购物车数据仅保存在当前设备的本地缓存中,不会同步到服务器或其他设备。

**Why this priority**: 这是用户体验的重要保障,避免用户每次打开应用都要重新添加商品。采用前端缓存方案可以实现即时响应,无需网络请求,同时降低后端存储成本。虽然不是核心交互功能,但对用户留存和转化率有显著影响。

**Independent Test**: 可以通过在购物车添加商品,关闭小程序,断网后重新打开,验证购物车商品是否仍然保留来独立测试(无需网络请求)。

**Acceptance Scenarios**:

1. **Given** 用户在"江苏省-南京市"购物车添加了3种商品, **When** 用户关闭小程序并重新打开, **Then** 切换到"江苏省-南京市"后购物车仍显示这3种商品(数据从localStorage读取)
2. **Given** 用户在3个不同地区分别添加了商品, **When** 用户关闭小程序并重新打开, **Then** 所有地区的购物车数据都保留,切换地区后正确显示对应购物车(所有地区数据都从localStorage读取)
3. **Given** 用户在购物车有商品, **When** 用户完成订单支付后, **Then** 当前地区购物车被清空(localStorage中对应地区数据删除),其他地区购物车不受影响
4. **Given** 用户在多个设备登录同一账号, **When** 用户在设备A添加商品到购物车, **Then** 设备B的购物车不显示设备A添加的商品(购物车数据仅存储在本地localStorage,不同步到服务器或其他设备)
5. **Given** 用户在离线状态(无网络), **When** 用户打开小程序并访问购物车, **Then** 购物车仍能正常显示之前添加的商品(完全依赖localStorage,无需网络请求)

---

### Edge Cases

- **地区切换时的购物车状态**: 当用户在购物车页面通过RegionBar切换地区时,页面需要立即刷新显示新地区的购物车内容,避免显示旧地区的商品
- **商品库存不足**: 当用户增加商品数量超过库存限制时,显示Toast提示"库存不足,当前最多可购买X件",数量保持在库存范围内
- **商品已下架**: 当购物车中的商品已下架(商家停售)时,商品卡片显示"该商品已下架"灰色遮罩,无法增加数量,只能删除
- **数量调整的边界值**: 数量减少到1时,点击"-"按钮无效果(最小数量为1,删除需使用删除按钮)
- **清空购物车的误操作防护**: 点击"清空购物车"必须弹出二次确认对话框,防止用户误触
- **结算时的登录状态检查**: 点击"去结算"时检查登录状态,未登录时引导登录,登录成功后自动返回结算流程
- **购物车为空时的操作限制**: 当购物车为空时,"清空购物车"和"去结算"按钮显示禁用状态
- **跨地区商品价格差异**: 同一商品在不同地区价格可能不同,购物车显示的价格基于当前地区的商品数据
- **地区数据不一致**: 当用户在地区A添加商品后,该商品在地区A被删除(商家停售),购物车中该商品显示"已下架"标记
- **购物车数量限制**: 单个地区购物车最多支持50种商品,超过限制时显示提示"购物车已满,请先结算部分商品"
- **快速点击增减按钮**: 防抖处理,避免快速点击导致数量异常或本地存储写入过于频繁
- **支付成功后的购物车清理**: 订单支付成功后,自动清空当前地区购物车,避免重复下单
- **本地存储数据损坏**: 当从localStorage读取购物车数据失败时,初始化为空购物车,不影响正常使用
- **商品单位不一致**: 商品单位(斤/kg/袋)不同,价格计算和数量显示需要正确处理单位

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 购物车页面必须在顶部显示RegionBar组件,展示当前选择的地区(省份-城市)
- **FR-002**: 购物车页面必须只显示当前地区的商品列表,不同地区的购物车内容相互隔离
- **FR-003**: 每个商品卡片必须显示商品图片、名称、单价(¥X/单位)、数量控制器、删除按钮
- **FR-004**: 购物车底部必须显示统计信息:商品种类数、商品总数量、总金额
- **FR-005**: 用户必须能够通过点击"+"按钮增加商品数量,"-"按钮减少商品数量(最小为1)
- **FR-006**: 用户必须能够通过点击删除按钮(垃圾桶图标)移除单个商品
- **FR-007**: 购物车必须提供"清空购物车"按钮,点击后显示二次确认对话框,确认后清空当前地区所有商品
- **FR-008**: 当购物车为空时,"清空购物车"和"去结算"按钮必须显示禁用状态
- **FR-009**: 购物车为空时,必须显示空状态插画和提示文字,以及当前地区信息
- **FR-010**: 购物车必须提供"去结算"按钮,点击后跳转到订单确认页面
- **FR-011**: 点击"去结算"时,必须检查用户登录状态,未登录时引导登录
- **FR-012**: 用户通过RegionBar切换地区时,购物车页面必须立即刷新显示新地区的购物车内容
- **FR-013**: TabBar的购物车图标必须显示徽标,显示所有地区购物车的商品种类总数
- **FR-014**: 当所有地区购物车都为空时,TabBar购物车图标不显示徽标
- **FR-015**: 购物车数据必须保存到前端本地存储(localStorage),小程序重启后数据保留,**不同步到服务器**
- **FR-016**: 购物车数据必须按地区键(province-city)分组存储,格式为RegionalCart对象,存储键名为"regional_cart_data"
- **FR-017**: 修改商品数量或删除商品后,必须立即更新本地localStorage和页面统计信息,无需调用后端API
- **FR-018**: 当用户增加商品数量超过库存限制时,必须显示Toast提示"库存不足,当前最多可购买X件"
- **FR-019**: 当购物车中的商品已下架时,商品卡片必须显示"该商品已下架"灰色遮罩,只能删除不能增加数量
- **FR-020**: 单个地区购物车最多支持50种商品,超过限制时必须显示提示"购物车已满,请先结算部分商品"
- **FR-021**: 订单支付成功后,必须自动清空当前地区的购物车
- **FR-022**: 快速点击增减按钮时,必须进行防抖处理,避免数量异常
- **FR-023**: 从本地存储读取购物车数据失败时,必须初始化为空购物车,不影响正常使用
- **FR-024**: 商品单价显示必须包含单位(如¥5/斤、¥10/kg),小计和总计显示为金额格式(¥XX.XX)
- **FR-025**: 购物车页面必须支持下拉刷新,刷新商品信息(价格、库存、上下架状态)

### Key Entities

- **商品(Product)**: 购物车中的商品信息,包含商品ID、名称、价格、图片URL、单位(斤/kg/袋)、库存数量、上架状态
- **购物车项(CartItem)**: 购物车中的单个条目,包含商品(Product)、数量(quantity)、添加时间戳(addedAt)
- **地区键(RegionKey)**: 地区的唯一标识,格式为"省份-城市"(如"江苏省-南京市"),用于隔离不同地区的购物车
- **地区化购物车(RegionalCart)**: 按地区键分组的购物车数据结构,键为RegionKey,值为CartItem数组
- **购物车统计(CartStats)**: 当前地区购物车的统计信息,包含商品种类数(itemCount)、商品总数量(totalItems)、总金额(totalAmount)
- **订单(Order)**: 购物车结算后生成的订单,包含订单号、商品列表、购买地区、总金额、支付状态、配送方式(核销自提/跑腿配送)
- **核销券(Voucher)**: 订单支付成功后生成的核销凭证,绑定订单和购买地区,用于线下核销

**注**: 购物车不直接处理门店(Store)、支付(Payment)等实体,这些实体在订单确认页和支付流程中处理。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户从点击TabBar"购物车"到购物车页面完全加载完成的时间不超过1秒(正常网络环境下)
- **SC-002**: 90%的用户能够在2次点击内完成从购物车到订单确认页面的操作(点击"去结算"→跳转)
- **SC-003**: 购物车数据持久化成功率达到100%,小程序重启后购物车商品保留
- **SC-004**: 地区切换后购物车内容刷新响应时间不超过500毫秒
- **SC-005**: 用户修改商品数量后,统计信息(商品数量、总金额)的更新延迟不超过100毫秒
- **SC-006**: 购物车商品种类数和总金额的计算准确率达到100%,无四舍五入误差(精确到分)
- **SC-007**: 用户对购物车页面的整体满意度达到80%以上(通过用户反馈或评分调研)
- **SC-008**: 购物车操作(增加、减少、删除商品)的失败率低于0.5%(排除网络异常)
- **SC-009**: 用户从购物车进入订单确认页面的转化率达到60%以上,表明购物车设计有效引导结算
- **SC-010**: TabBar购物车徽标显示的准确率达到100%,实时反映所有地区购物车商品总数
- **SC-011**: 因购物车设计问题导致的客服咨询量不超过总用户量的0.5%
- **SC-012**: 购物车页面在正常网络环境下,内存占用不超过30MB,滚动帧率保持在50fps以上

## Assumptions

1. **地区选择持久化**: 假设用户选择的地区信息已持久化存储(RegionContext),购物车能够准确获取当前地区
2. **商品数据可用性**: 假设后端提供商品信息查询API,包含商品ID、名称、价格、图片、单位、库存、上架状态,响应时间在200ms以内
3. **本地存储可用**: 假设小程序的localStorage功能正常可用,存储容量足够(至少10MB),能够保存购物车数据
4. **订单系统集成**: 假设应用已具备完整的订单系统和支付流程,购物车结算后能够生成订单和核销券
5. **用户登录状态**: 假设应用具备完整的用户登录和身份验证机制,购物车能够准确获取登录状态
6. **网络环境**: 假设用户在正常网络环境下访问(4G/5G/Wi-Fi),弱网环境通过加载提示优化体验
7. **商品价格一致性**: 假设同一商品在同一地区的价格在购物车和订单确认页面保持一致,价格变动时购物车能够刷新最新价格
8. **购物车容量限制**: 假设单个地区购物车最多支持50种商品,单个商品最大数量为999件,超过限制时前端拦截
9. **地区数量限制**: 假设用户最多在10个不同地区添加购物车商品,超过限制时提示"地区购物车数量已达上限"
10. **库存实时性**: 假设购物车不强制要求库存实时同步,允许用户添加商品到购物车时不检查库存,结算时再检查库存
11. **购物车仅前端缓存**: **明确购物车数据仅保存在前端localStorage中,不同步到服务器后端**。用户在不同设备登录后,购物车内容相互独立,不跨设备同步。这是降低后端存储成本和提升响应速度的设计决策。
12. **商品下架处理**: 假设商品下架后,购物车中该商品仍保留但标记为"已下架",由用户决定是否删除

## Dependencies

- **地区选择功能(RegionContext)**: 需要RegionContext提供当前选择的省份和城市信息,以及地区切换事件
- **商品信息API**: 需要后端提供商品详情查询接口,用于刷新购物车中商品的价格、库存、上架状态(仅在下拉刷新时调用,非实时同步)
- **用户认证服务**: 需要后端提供用户登录验证接口,购物车结算时检查登录状态
- **订单系统**: 需要依赖订单确认页面,购物车结算后跳转到订单确认页,展示商品列表和配送信息
- **支付系统**: 需要依赖支付流程,订单支付成功后清空当前地区购物车(从localStorage删除对应数据),生成核销券
- **前端本地存储服务**: **购物车完全依赖小程序的localStorage API进行数据持久化,不依赖后端购物车存储服务**。存储键名为"regional_cart_data",数据格式为JSON序列化的RegionalCart对象
- **TabBar组件**: 需要自定义TabBar组件支持徽标显示,显示所有地区购物车商品总数(从localStorage读取并计算)
- **RegionBar组件**: 需要RegionBar组件显示当前地区,支持地区切换
- **Toast提示组件**: 需要NutUI的Toast组件,用于显示操作反馈(加入购物车、库存不足等)
- **确认对话框组件**: 需要NutUI的Dialog组件,用于清空购物车的二次确认
