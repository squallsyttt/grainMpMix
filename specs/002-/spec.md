# Feature Specification: 核销券个人中心

**Feature Branch**: `002-`
**Created**: 2025-10-12
**Status**: Draft
**Input**: User description: "这个项目和一般的商城平台有比较大的区别,就是你购买商品之后,每个商品都是属于直接从平台购买的。购买的时候完全没有商品属于某个商家这种概念,商品会属于不同的大米分类,但是在一个地区,每一种商品在平台内展示的都只有一种价格。比如你在南通购买,你先在平台选择南通,看到的价格就是南通的大米的价格,购买成功之后,用户收到的是一个核销券。在核销券的详情里,会展示平台入驻的同样上架了对应这个分类大米的店铺。用户可以自己选择去某个店铺核销自提。是这样一个概念。根据这个逻辑完善一下个人中心,他有订单的概念,但是不是那种下单了直接就等快递的模式。当然后面也会兼容一下跑腿模式,但是个人中心应该以核销概念为核心去构建。每次购买完成后,核销详情里面需要是一个二维码,后续用来给商家进行核销的。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看核销券列表 (Priority: P1)

用户购买大米后,需要在个人中心查看自己获得的核销券,并了解每张券的状态(待核销、已核销、已过期),以便管理自己的权益。

**Why this priority**: 这是核销券体系的核心入口,用户购买后的第一个交互点,必须优先实现。没有这个功能,用户无法看到自己的购买结果。

**Independent Test**: 可以通过创建测试订单,检查个人中心是否正确显示核销券列表,包括券的基本信息(商品名称、购买时间、状态)和正确的状态筛选功能来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录且有3张核销券(1张待核销、1张已核销、1张已过期), **When** 用户进入个人中心, **Then** 默认显示所有状态的券列表,每张券显示商品图片、商品名称、规格、购买数量、购买时间、当前状态
2. **Given** 用户在核销券列表页面, **When** 用户点击"待核销"标签, **Then** 列表只显示状态为"待核销"的券
3. **Given** 用户有超过20张核销券, **When** 用户滚动列表到底部, **Then** 自动加载下一页券数据
4. **Given** 用户没有任何核销券, **When** 用户进入个人中心, **Then** 显示空状态提示"暂无核销券,去商城逛逛吧"并提供跳转按钮

---

### User Story 2 - 查看核销券详情及二维码 (Priority: P1)

用户选择某张待核销的券后,需要查看详细信息和核销二维码,包括可以核销的门店列表,以便前往门店出示二维码完成核销自提。

**Why this priority**: 这是核销流程的关键环节,用户凭二维码到店核销是业务闭环的核心。没有二维码和门店信息,整个核销体系无法运转。

**Independent Test**: 可以通过点击任意待核销券,检查是否显示完整的券详情(商品信息、订单信息、核销二维码、可核销门店列表),并验证二维码是否可被扫描识别来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户在核销券列表页面, **When** 用户点击某张待核销的券, **Then** 进入详情页,显示商品详细信息(图片、名称、规格、分类)、订单信息(订单号、购买时间、支付金额)、核销二维码(清晰可扫描)
2. **Given** 用户在核销券详情页, **When** 页面加载完成, **Then** 显示该大米分类在当前地区的可核销门店列表,每个门店显示名称、地址、距离、营业时间、联系电话
3. **Given** 用户在门店列表中, **When** 用户点击某个门店的地址, **Then** 打开地图应用导航到该门店
4. **Given** 用户查看已核销的券详情, **When** 页面加载完成, **Then** 显示核销时间、核销门店信息,二维码显示为灰色不可用状态
5. **Given** 用户在核销券详情页, **When** 用户点击保存二维码按钮, **Then** 二维码图片保存到相册并提示"已保存到相册"

---

### User Story 3 - 门店核销操作 (Priority: P2)

商家使用扫码设备扫描用户的核销二维码后,系统需要验证券的有效性并完成核销,更新券状态为"已核销",以便用户可以提货并防止重复核销。

**Why this priority**: 这是商家端的关键功能,完成业务闭环。虽然是商家操作,但会直接影响用户端券状态的更新。

**Independent Test**: 可以通过商家扫描测试二维码,验证系统是否正确识别券信息、检查券状态、完成核销并更新用户端显示来独立测试。

**Acceptance Scenarios**:

1. **Given** 商家使用扫码设备, **When** 扫描用户的待核销券二维码, **Then** 显示券的详细信息(商品名称、规格、数量、用户信息)并提示"确认核销"
2. **Given** 商家在核销确认页面, **When** 点击"确认核销"按钮, **Then** 券状态更新为"已核销",记录核销时间和门店信息,用户端同步更新
3. **Given** 商家扫描已核销的券, **When** 二维码被识别, **Then** 显示"该券已核销"并展示核销记录(核销时间、门店名称)
4. **Given** 商家扫描已过期的券, **When** 二维码被识别, **Then** 显示"该券已过期"并禁止核销操作
5. **Given** 商家扫描损坏或无效的二维码, **When** 扫描识别, **Then** 提示"无效的核销码"

---

### User Story 4 - 订单记录查询 (Priority: P2)

用户需要查看完整的购买订单记录,包括订单详情(商品信息、支付金额、购买时间、订单状态),以便追溯购买历史和核对信息。

**Why this priority**: 订单记录是用户权益凭证,虽然核销券是主要交互对象,但订单记录对于用户查账、客服处理纠纷等场景必不可少。

**Independent Test**: 可以通过创建多个测试订单,检查订单列表是否正确显示所有订单信息,并验证订单详情页是否展示完整信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已登录, **When** 用户进入"我的订单"页面, **Then** 显示所有订单列表,每个订单显示订单号、商品缩略图、商品名称、购买数量、支付金额、订单状态、购买时间
2. **Given** 用户在订单列表页面, **When** 用户点击某个订单, **Then** 进入订单详情页,显示完整订单信息(订单号、商品详情、数量、单价、总价、支付方式、支付时间、收货人信息[如果是跑腿模式])
3. **Given** 用户在订单详情页, **When** 订单状态为"已完成"(已核销), **Then** 显示关联的核销券信息和"查看核销券"按钮,点击后跳转到券详情
4. **Given** 用户在订单列表页面, **When** 用户下拉刷新, **Then** 重新加载最新的订单数据
5. **Given** 用户有超过20个订单, **When** 用户滚动到列表底部, **Then** 自动加载下一页订单数据

---

### User Story 5 - 核销券有效期管理 (Priority: P3)

系统需要自动管理核销券的有效期,在券即将过期时提醒用户,过期后自动更新状态,帮助用户及时使用权益,避免浪费。

**Why this priority**: 这是用户体验优化功能,避免用户忘记使用导致权益损失,但不影响核心核销流程。

**Independent Test**: 可以通过创建不同有效期的测试券,验证系统是否正确发送过期提醒、更新过期状态、在列表中正确标识即将过期的券来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户有一张核销券距离过期还有3天, **When** 系统检测到即将过期, **Then** 向用户发送提醒通知"您有1张核销券将在3天后过期,请尽快使用"
2. **Given** 用户在核销券列表页面, **When** 某张券距离过期不足7天, **Then** 在券卡片上显示"即将过期"标签并用醒目颜色标识
3. **Given** 核销券的有效期已到, **When** 系统执行定时检查, **Then** 自动将券状态更新为"已过期"
4. **Given** 用户查看已过期的券详情, **When** 页面加载, **Then** 显示过期时间并提示"该券已过期,如有疑问请联系客服"
5. **Given** 用户在券详情页, **When** 券状态为待核销, **Then** 显示剩余有效天数或具体过期日期

---

### User Story 6 - 跑腿配送模式入口预留 (Priority: P3)

为未来的跑腿配送功能预留UI入口和基础交互界面,方便后续功能扩展,当前阶段只需要展示占位界面和基本提示信息。

**Why this priority**: 这是未来扩展功能的占位,当前版本不实现完整功能,只需要预留入口和简单的占位界面即可。核心业务聚焦于核销券模式。

**Independent Test**: 可以通过访问订单详情页面,验证当订单为跑腿配送类型时,是否显示基础的占位界面和"敬请期待"或"开发中"的提示信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户有跑腿配送订单, **When** 用户在订单列表中查看, **Then** 订单卡片显示配送方式标识"跑腿配送",与核销自提订单有明确区分
2. **Given** 用户点击跑腿配送订单, **When** 进入订单详情页, **Then** 显示基本订单信息(订单号、商品信息、收货地址)和占位提示"配送功能开发中,敬请期待"
3. **Given** 用户在个人中心, **When** 订单列表提供配送方式筛选, **Then** 可以看到"跑腿配送"选项(当前显示为灰色或标注"即将上线")

---

### Edge Cases

- **核销券二维码生成失败**: 当系统无法生成二维码时(网络异常、服务故障),显示"二维码加载失败,请稍后重试"并提供手动刷新按钮
- **用户地理位置获取失败**: 当无法获取用户位置计算门店距离时,门店列表按默认顺序显示,距离字段显示"--"
- **同一张券被重复扫描**: 商家在短时间内(如5秒内)重复扫描同一张券时,系统识别为误操作,提示"请勿重复扫描"
- **核销时网络中断**: 商家确认核销时网络中断,系统应缓存核销请求,网络恢复后自动重试,避免核销状态不一致
- **券列表数据加载失败**: 当列表数据加载失败时(网络异常、超时),显示错误提示"加载失败,点击重试"并提供重试按钮
- **过期券数量过多**: 当用户有大量过期券(超过50张)时,默认隐藏过期券,提供"查看已过期券"入口,避免列表过长
- **地区切换后的核销规则**: 核销券绑定购买时的地区,只能在原地区的门店核销。用户切换到其他地区后无法使用该券,券详情页必须明确标识"仅限XX地区使用"。这确保了地区定价策略的一致性,避免跨地区套利
- **并发核销冲突**: 当同一张券被多个商家几乎同时扫描时,系统应通过锁机制确保只有一次核销成功,其他请求返回"该券已被核销"
- **券详情页门店列表为空**: 当某个大米分类在当前地区暂无可核销门店时,显示"该商品暂无可核销门店,我们会尽快补充"并提供客服联系方式

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须为每个用户提供个人中心入口,展示核销券、订单、个人信息等模块
- **FR-002**: 系统必须在用户完成支付后立即生成核销券,包含唯一券码、商品信息、购买时间、有效期、初始状态为"待核销"
- **FR-003**: 核销券列表必须支持按状态筛选(全部、待核销、已核销、已过期),默认显示全部状态
- **FR-004**: 每张核销券必须显示商品图片、名称、规格、购买数量、购买时间、当前状态
- **FR-005**: 核销券详情页必须生成清晰可扫描的二维码,二维码内容包含券的唯一标识和验证信息
- **FR-006**: 核销券详情页必须展示该大米分类在用户当前地区的所有可核销门店列表
- **FR-007**: 门店信息必须包含门店名称、详细地址、距离(基于用户位置)、营业时间、联系电话
- **FR-008**: 用户必须能点击门店地址打开地图应用进行导航
- **FR-009**: 商家扫描核销二维码后,系统必须验证券的有效性(状态为待核销、未过期)
- **FR-010**: 核销确认后,系统必须更新券状态为"已核销",记录核销时间、核销门店信息
- **FR-011**: 已核销和已过期的券的二维码必须显示为不可用状态(灰色或带水印)
- **FR-012**: 订单列表必须显示所有订单,包含订单号、商品信息、支付金额、订单状态、购买时间
- **FR-013**: 订单详情必须展示完整信息:订单号、商品详情、数量、单价、总价、支付方式、支付时间
- **FR-014**: 已完成的订单详情必须提供"查看核销券"入口,点击跳转到关联的核销券详情
- **FR-015**: 系统必须为每张券设置有效期,默认为购买后30天内有效
- **FR-016**: 系统必须在券距离过期3天时向用户发送提醒通知
- **FR-017**: 系统必须在券过期当日自动将状态更新为"已过期"
- **FR-018**: 即将过期的券(剩余7天内)必须在列表中显示"即将过期"标签并用醒目颜色标识
- **FR-019**: 跑腿配送订单必须在订单列表中显示配送方式标识"跑腿配送",与核销自提订单有明确区分
- **FR-020**: 跑腿配送订单详情页必须显示基本订单信息(订单号、商品信息、收货地址)和占位提示"配送功能开发中,敬请期待"
- **FR-021**: 核销券列表和订单列表必须支持分页加载,每页显示20条记录
- **FR-022**: 核销券列表必须支持下拉刷新,订单列表也必须支持下拉刷新
- **FR-023**: 系统必须记录每次核销操作的日志,包括券码、核销时间、门店、操作人员
- **FR-024**: 用户必须能保存核销二维码到相册,方便离线使用
- **FR-025**: 已核销的券详情必须显示核销时间和核销门店信息
- **FR-026**: 核销券的有效期信息必须在详情页明确展示(剩余天数或具体过期日期)
- **FR-027**: 核销券必须绑定购买时的地区,只能在该地区的门店核销,券详情页必须显示"仅限XX地区使用"的提示
- **FR-028**: 商家核销时,系统必须验证门店所属地区与券绑定的地区是否一致,不一致则拒绝核销并提示"该券仅限XX地区使用"

### Key Entities

- **核销券(Voucher)**: 用户购买商品后获得的核销凭证,包含券码、商品信息(名称、规格、分类、图片)、购买数量、购买时间、购买地区、有效期、状态(待核销/已核销/已过期)、关联订单号、核销记录(核销时间、核销门店)、二维码内容
- **订单(Order)**: 用户的购买记录,包含订单号、商品信息、购买数量、单价、总价、支付方式、支付时间、订单状态、配送方式(核销自提/跑腿配送)、收货信息(跑腿模式,当前仅记录基本信息)、关联的核销券码
- **门店(Store)**: 平台入驻的实体店铺,包含门店名称、详细地址、地理坐标、营业时间、联系电话、所属地区、上架的大米分类列表
- **大米分类(RiceCategory)**: 商品的分类标识,包含分类名称、描述、图片、地区价格信息
- **核销记录(WriteOffRecord)**: 记录核销操作的详细信息,包含券码、核销时间、核销门店、操作人员、操作结果

**注**: 配送信息(DeliveryInfo)作为未来扩展功能预留,当前版本仅在订单实体中存储基本的收货地址信息,不实现完整的配送跟踪和配送员管理功能。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在购买完成后30秒内可以在个人中心看到新的核销券
- **SC-002**: 核销券列表页面加载时间不超过2秒(20条记录)
- **SC-003**: 用户从进入券详情到看到二维码的时间不超过1.5秒
- **SC-004**: 商家扫码核销的响应时间不超过3秒(从扫描到确认完成)
- **SC-005**: 90%的用户能够在首次使用时成功找到核销券并查看门店列表,无需客服帮助
- **SC-006**: 核销券二维码在各类扫码设备上的识别成功率达到99%以上
- **SC-007**: 系统支持至少5000个并发用户同时访问个人中心而不出现性能下降
- **SC-008**: 核销券过期提醒的发送准确率达到100%(所有距过期3天的券都收到提醒)
- **SC-009**: 核销操作的成功率达到99%(排除网络异常等不可控因素)
- **SC-010**: 用户能够在3次点击内完成从个人中心到门店导航的完整流程
- **SC-011**: 95%的核销券能够在购买后7天内被核销,避免浪费
- **SC-012**: 因核销券功能引起的客服咨询量不超过总订单量的2%

## Assumptions

1. **地理位置权限**: 假设用户已授权应用获取地理位置信息,用于计算门店距离和排序。如未授权,门店列表按默认顺序显示
2. **核销券有效期**: 假设所有核销券的默认有效期为购买后30天,除非业务规则另有规定
3. **二维码技术标准**: 假设使用标准QR Code格式生成二维码,兼容市面上主流扫码设备
4. **网络环境**: 假设用户在查看核销券详情时有网络连接,离线场景可通过保存二维码到相册来应对
5. **门店数据完整性**: 假设平台已维护完整的门店信息(地址、营业时间、联系方式),且门店与大米分类的关联关系准确
6. **支付成功即时性**: 假设用户完成支付后,支付系统会实时通知业务系统生成核销券,延迟不超过10秒
7. **一券一核销**: 假设每张核销券只能核销一次,核销后不可撤销或重复使用
8. **跑腿模式为占位功能**: 假设当前版本核销自提为主要模式,跑腿配送仅预留UI入口和基础占位界面,不实现完整的配送跟踪、配送员管理等功能,不影响核心核销流程
9. **通知推送能力**: 假设系统具备向用户发送通知的能力(站内消息、微信模板消息或推送通知),用于过期提醒
10. **商家端设备**: 假设商家具备扫码设备(手机、扫码枪或POS机),能够扫描用户的核销二维码并联网验证
11. **地区绑定策略**: 假设核销券严格绑定购买地区,不支持跨地区核销,这是为了维护各地区独立定价策略并防止套利行为
